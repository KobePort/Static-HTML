<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倒數計時器</title>
    <!-- 引入 Tone.js 實現聲音效果 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
            /* 將預設背景色改為深灰色 (gray-800) */
            background-color: #1f2937; 
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- 主容器 -->
    <!-- 初始設定為深色卡片 (bg-gray-800, text-white) -->
    <div id="mainContainer" class="bg-gray-800 p-8 sm:p-12 rounded-2xl shadow-white/20 shadow-2xl w-full max-w-lg text-center transition duration-300">
        <h1 id="headerTitle" class="text-3xl sm:text-4xl font-extrabold text-white mb-8 transition duration-300">
            計時器
        </h1>

        <!-- 計時器顯示區 -->
        <!-- 初始設定為深色背景 (bg-gray-700, border-gray-600) -->
        <div id="timerDisplay" class="text-7xl sm:text-8xl font-mono font-bold text-red-600 mb-10 p-6 bg-gray-700 rounded-xl border-4 border-gray-600 transition duration-300 ease-in-out select-none">
            05:00
        </div>

        <!-- 預設時間按鈕群組 (5分, 10分, 20分) -->
        <div class="flex justify-center space-x-4 mb-8">
            <button onclick="setPreset(300)" id="preset-5m"
                    class="preset-button bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-105 active:scale-95 text-lg">
                5 分鐘
            </button>
            <button onclick="setPreset(600)" id="preset-10m"
                    class="preset-button bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-105 active:scale-95 text-lg">
                10 分鐘
            </button>
            <button onclick="setPreset(1200)" id="preset-20m"
                    class="preset-button bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-105 active:scale-95 text-lg">
                20 分鐘
            </button>
        </div>
        
        <!-- 自訂時間輸入區 -->
        <!-- 初始設定為深色輸入框 (bg-gray-900, border-gray-600, text-white) -->
        <div class="mt-4 mb-8 flex items-center space-x-3">
            <input type="number" id="customMinutesInput" placeholder="輸入分鐘數 (e.g., 3, 15)" min="1"
                   class="flex-1 p-3 text-lg border border-gray-600 rounded-xl focus:ring-green-500 focus:border-green-500 transition duration-150 outline-none bg-gray-900 text-white">
            <button onclick="setCustomTime()"
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-105 active:scale-95 text-lg whitespace-nowrap">
                設定自訂時間
            </button>
        </div>


        <!-- 控制按鈕群組 -->
        <div class="flex justify-center space-x-4">
            <button id="startPauseButton"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] active:scale-[0.98] text-xl">
                開始
            </button>
            <button id="resetButton"
                    class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] active:scale-[0.98] text-xl">
                重設
            </button>
        </div>
        
        <!-- 新增主題切換按鈕 -->
        <!-- 初始按鈕文字改為切換為淺色主題 -->
        <div class="mt-4">
            <button id="themeToggleButton" onclick="toggleTheme()"
                    class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-xl shadow transition duration-150 transform hover:scale-[1.01] active:scale-[0.99] text-base">
                切換為淺色主題
            </button>
        </div>

        <!-- 狀態訊息 -->
        <!-- 初始文字顏色改為淺灰色 (text-gray-300) -->
        <div id="statusMessage" class="mt-6 h-6 text-sm text-gray-300 font-medium transition duration-300">
            預設時間：5 分鐘
        </div>
    </div>

    <script>
        // DOM 元素
        const timerDisplay = document.getElementById('timerDisplay');
        const startPauseButton = document.getElementById('startPauseButton');
        const resetButton = document.getElementById('resetButton');
        const statusMessage = document.getElementById('statusMessage');
        const customMinutesInput = document.getElementById('customMinutesInput'); 
        const mainContainer = document.getElementById('mainContainer');
        const headerTitle = document.getElementById('headerTitle');
        const themeToggleButton = document.getElementById('themeToggleButton');

        // 計時器狀態變數
        let totalSeconds; // 當前總秒數
        let timerInterval; // 儲存 setInterval 呼叫的 ID
        let isRunning = false;
        const DEFAULT_START_TIME = 300; // 5 分鐘 (300 秒)
        let lastSetTime = DEFAULT_START_TIME; // 儲存上次設定的時間
        let currentTheme = 'dark'; // **重要變更：將預設主題改為 'dark'**
        
        // ========== TONE.JS 聲音設定 ==========
        // 初始化一個簡單的合成器來發出「叮」聲
        const synth = new Tone.MembraneSynth().toDestination();
        let audioContextStarted = false;

        /**
         * 啟動 Web Audio Context，這通常需要在使用者第一次與頁面互動時觸發。
         */
        function startAudioContext() {
            if (!audioContextStarted) {
                // Tone.start() 必須由使用者操作觸發
                Tone.start().then(() => {
                    audioContextStarted = true;
                    console.log("Audio Context Started.");
                }).catch(err => {
                    console.error("無法啟動音訊環境:", err);
                });
            }
        }

        /**
         * 播放「叮」一聲。
         */
        function playDing() {
            // 播放一個短促、高音的音符 (A4 = 440 Hz)
            synth.triggerAttackRelease("A4", "8n"); 
        }
        // ============================================

        /**
         * 切換頁面的背景顏色和主題。
         */
        function toggleTheme() {
            const body = document.body;
            
            if (currentTheme === 'light') {
                // 切換到深色主題
                currentTheme = 'dark';
                
                // Body (深灰背景)
                body.style.backgroundColor = '#1f2937'; // Tailwind gray-800
                
                // Main Container (深色卡片)
                mainContainer.classList.remove('bg-white', 'shadow-2xl');
                mainContainer.classList.add('bg-gray-800', 'shadow-white/20');
                
                // 文字/標題 (白色文字)
                headerTitle.classList.replace('text-gray-800', 'text-white');
                statusMessage.classList.replace('text-gray-600', 'text-gray-300');
                
                // 計時器顯示區
                timerDisplay.classList.replace('bg-red-50', 'bg-gray-700');
                timerDisplay.classList.replace('border-red-200', 'border-gray-600');
                
                // 輸入框
                customMinutesInput.classList.remove('border-gray-300', 'bg-white');
                customMinutesInput.classList.add('border-gray-600', 'bg-gray-900', 'text-white');

                // 按鈕文字
                themeToggleButton.textContent = '切換為淺色主題';
                themeToggleButton.classList.replace('bg-gray-600', 'bg-gray-500');
                
            } else {
                // 切換回淺色主題
                currentTheme = 'light';

                // Body (淺灰背景)
                body.style.backgroundColor = '#f3f4f6'; 

                // Main Container (白色卡片)
                mainContainer.classList.add('bg-white', 'shadow-2xl');
                mainContainer.classList.remove('bg-gray-800', 'shadow-white/20');

                // 文字/標題 (深色文字)
                headerTitle.classList.replace('text-white', 'text-gray-800');
                statusMessage.classList.replace('text-gray-300', 'text-gray-600');

                // 計時器顯示區
                timerDisplay.classList.replace('bg-gray-700', 'bg-red-50');
                timerDisplay.classList.replace('border-gray-600', 'border-red-200');
                
                // 輸入框
                customMinutesInput.classList.remove('border-gray-600', 'bg-gray-900', 'text-white');
                customMinutesInput.classList.add('border-gray-300', 'bg-white');
                
                // 按鈕文字
                themeToggleButton.textContent = '切換為深色主題';
                themeToggleButton.classList.replace('bg-gray-500', 'bg-gray-600');
            }
        }


        /**
         * 初始化計時器到預設時間。
         */
        function initializeTimer() {
            totalSeconds = DEFAULT_START_TIME;
            lastSetTime = DEFAULT_START_TIME; // 初始化上次設定的時間
            updateDisplay();
            statusMessage.textContent = '預設時間：5 分鐘';
        }

        /**
         * 格式化秒數為 MM:SS 格式。
         * @param {number} seconds - 總秒數。
         * @returns {string} - 格式化後的字串 (e.g., "05:00")。
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${paddedMinutes}:${paddedSeconds}`;
        }

        /**
         * 更新顯示的計時器時間。
         */
        function updateDisplay() {
            timerDisplay.textContent = formatTime(totalSeconds);
            // 閃爍效果 (最後 10 秒)
            if (totalSeconds <= 10 && totalSeconds > 0 && isRunning) {
                 timerDisplay.classList.add('animate-pulse', 'bg-red-100');
            } else {
                 timerDisplay.classList.remove('animate-pulse', 'bg-red-100');
            }
        }

        /**
         * 計時器的核心邏輯：每秒執行一次。
         */
        function countdown() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
            } else {
                // 計時結束
                pauseTimer(false); // 停止計時，但不修改按鈕文字
                
                // 發出「叮」聲 (新增)
                if (audioContextStarted) {
                    playDing();
                }

                // 啟動閃爍提醒，然後自動重啟
                startFlashingAlert(5, 400); // 閃爍 5 次，間隔 400ms
            }
        }

        /**
         * 啟動計時結束的閃爍提醒。
         * @param {number} times - 閃爍次數。
         * @param {number} interval - 閃爍間隔 (毫秒)。
         */
        function startFlashingAlert(times, interval) {
            let count = 0;
            const maxFlashes = times * 2; // 2 steps (on/off) per flash
            statusMessage.textContent = '計時結束！自動重設中...';
            
            function flash() {
                if (count >= maxFlashes) {
                    // 閃爍結束，清理樣式並啟動下一輪
                    timerDisplay.classList.remove('bg-red-500', 'text-white', 'bg-red-50', 'bg-gray-700');
                    // 根據當前主題設定背景色
                    if (currentTheme === 'light') {
                         timerDisplay.classList.add('bg-red-50');
                    } else {
                         timerDisplay.classList.add('bg-gray-700');
                    }
                    
                    autoRestart();
                    return;
                }

                if (count % 2 === 0) {
                    // 亮起：紅色背景，白色文字
                    timerDisplay.textContent = "TIME UP";
                    timerDisplay.classList.remove('bg-red-50', 'bg-gray-700');
                    timerDisplay.classList.add('bg-red-500', 'text-white');
                } else {
                    // 熄滅：預設背景，紅色文字 (顯示 00:00)
                    timerDisplay.textContent = "00:00";
                    timerDisplay.classList.remove('bg-red-500', 'text-white');
                    // 確保熄滅時使用正確的主題背景色
                    if (currentTheme === 'light') {
                         timerDisplay.classList.add('bg-red-50');
                    } else {
                         timerDisplay.classList.add('bg-gray-700');
                    }
                }
                
                count++;
                setTimeout(flash, interval);
            }
            
            // 首次呼叫
            flash();
        }

        /**
         * 自動重設並啟動下一輪計時 (使用上次設定的時間間隔)。
         */
        function autoRestart() {
            // 1. 重設總秒數到上次設定的時間
            totalSeconds = lastSetTime; // 使用 lastSetTime 
            
            // 2. 啟動計時器
            startTimer(); 
            const minutes = lastSetTime / 60; // 計算分鐘數以更新狀態訊息
            statusMessage.textContent = `自動重新啟動：新一輪計時 (${minutes} 分鐘) 中...`;
        }

        /**
         * 開始或暫停計時器。
         */
        function toggleTimer() {
            if (isRunning) {
                pauseTimer(true);
            } else {
                startTimer();
            }
        }
        
        /**
         * 啟動計時器。
         */
        function startTimer() {
            // 在使用者點擊「開始」時啟動音訊環境 (瀏覽器要求)
            startAudioContext(); 
            
            if (totalSeconds > 0) {
                isRunning = true;
                timerInterval = setInterval(countdown, 1000);
                startPauseButton.textContent = '暫停';
                startPauseButton.classList.replace('bg-blue-600', 'bg-yellow-600');
                startPauseButton.classList.replace('hover:bg-blue-700', 'hover:bg-yellow-700');
                statusMessage.textContent = '計時中...';
                
            } else {
                statusMessage.textContent = '請先設定時間或重設。';
            }
        }

        /**
         * 暫停計時器。
         * @param {boolean} updateButtonText - 是否更新按鈕文字為「繼續」。
         */
        function pauseTimer(updateButtonText) {
            clearInterval(timerInterval);
            isRunning = false;
            if (updateButtonText) {
                startPauseButton.textContent = '繼續';
                startPauseButton.classList.replace('bg-yellow-600', 'bg-blue-600');
                startPauseButton.classList.replace('hover:bg-yellow-700', 'hover:bg-blue-700');
                statusMessage.textContent = '已暫停';
            }
        }

        /**
         * 重設計時器到初始預設時間。
         */
        function resetTimer() {
            pauseTimer(false); // 停止計時
            totalSeconds = DEFAULT_START_TIME;
            lastSetTime = DEFAULT_START_TIME; // 重設 lastSetTime
            updateDisplay();
            startPauseButton.textContent = '開始';
            startPauseButton.classList.replace('bg-yellow-600', 'bg-blue-600');
            startPauseButton.classList.replace('hover:bg-yellow-700', 'hover:bg-blue-700');
            // 重設時確保主題顏色正確
            if (currentTheme === 'light') {
                timerDisplay.classList.remove('bg-red-500', 'text-white', 'bg-gray-700');
                timerDisplay.classList.add('bg-red-50');
            } else {
                timerDisplay.classList.remove('bg-red-500', 'text-white', 'bg-red-50');
                timerDisplay.classList.add('bg-gray-700');
            }
            statusMessage.textContent = `重設完成，當前時間：${formatTime(totalSeconds)}`;
        }

        /**
         * 設定預設時間。
         * @param {number} seconds - 要設定的總秒數。
         */
        function setPreset(seconds) {
            pauseTimer(false); // 停止計時
            totalSeconds = seconds;
            lastSetTime = seconds; // 儲存上次設定的時間
            updateDisplay();
            startPauseButton.textContent = '開始';
            startPauseButton.classList.replace('bg-yellow-600', 'bg-blue-600');
            startPauseButton.classList.replace('hover:bg-yellow-700', 'hover:bg-blue-700');
            // 設定預設時確保主題顏色正確
             if (currentTheme === 'light') {
                timerDisplay.classList.remove('bg-red-500', 'text-white', 'bg-gray-700');
                timerDisplay.classList.add('bg-red-50');
            } else {
                timerDisplay.classList.remove('bg-red-500', 'text-white', 'bg-red-50');
                timerDisplay.classList.add('bg-gray-700');
            }
            
            const minutes = seconds / 60;
            statusMessage.textContent = `已設定為：${minutes} 分鐘`;
        }

        /**
         * 設定自訂時間 (分鐘)。
         */
        function setCustomTime() {
            const minutes = parseInt(customMinutesInput.value);

            if (isNaN(minutes) || minutes <= 0) {
                statusMessage.textContent = '請輸入有效的正整數分鐘數。';
                // 視覺提示輸入錯誤
                customMinutesInput.classList.add('border-red-500', 'ring-2', 'ring-red-500');
                setTimeout(() => {
                    customMinutesInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                }, 1500);
                return;
            }

            const seconds = minutes * 60;
            setPreset(seconds); // setPreset 會儲存 lastSetTime
            
            // 設定時間後直接開始計時
            startTimer(); 
            
            customMinutesInput.value = ''; // 清空輸入框
        }

        // 事件監聽器
        startPauseButton.addEventListener('click', toggleTimer);
        resetButton.addEventListener('click', resetTimer);

        // 初始化
        initializeTimer();

    </script>
</body>
</html>